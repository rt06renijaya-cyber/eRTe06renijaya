<script>
// ======================
// PARSER GOOGLE SHEET + FIX JUMLAH
// ======================
async function loadSheet(gid) {
  const url = `https://docs.google.com/spreadsheets/d/1EMYpie82paCl-vupfhyj11Z9tNGFp2p7aIDwIIl_Z0o/gviz/tq?tqx=out:json&gid=${gid}`;

  const res = await fetch(url);
  const raw = await res.text();

  if (!raw.includes("google.visualization.Query.setResponse")) {
    alert("ERROR: Google Sheet kamu belum PUBLIC!\n\nUbah Share → Anyone with link → Viewer.");
    return [];
  }

  const clean = raw
    .replace("/*O_o*/", "")
    .replace("google.visualization.Query.setResponse(", "")
    .replace(/\);$/, "")
    .trim();

  const json = JSON.parse(clean);

  return json.table.rows.map(r => {
    const c = r.c;

    // Ambil nilai jumlah (bisa .v = null jika format Rp)
    let jumlahRaw = c[1]?.f || c[1]?.v || "0";

    // Bersihkan format: hilangkan Rp, titik, koma, spasi
    let jumlah = parseInt(
      String(jumlahRaw)
        .replace(/[^0-9\-]/g, "") // buang semua karakter selain angka
    );

    if (isNaN(jumlah)) jumlah = 0;

    return {
      tanggal: c[0]?.f || "",
      jumlah: jumlah,
      keterangan: c[2]?.v || "",
      kategori: c[3]?.v || "",
    };
  });
}

// ======================
// LOAD ALL DATA
// ======================
async function start() {
  const gidPemasukan   = 1722417630;
  const gidPengeluaran = 683283606;

  const pemasukan   = await loadSheet(gidPemasukan);
  const pengeluaran = await loadSheet(gidPengeluaran);

  const totalMasuk  = pemasukan.reduce((sum, d) => sum + d.jumlah, 0);
  const totalKeluar = pengeluaran.reduce((sum, d) => sum + d.jumlah, 0);
  const saldo       = totalMasuk - totalKeluar;

  document.getElementById("totalPemasukan").innerText  = formatRupiah(totalMasuk);
  document.getElementById("totalPengeluaran").innerText = formatRupiah(totalKeluar);
  document.getElementById("saldo").innerText           = formatRupiah(saldo);

  const semua = [
    ...pemasukan.map(d => ({ ...d, jenis: "Pemasukan" })),
    ...pengeluaran.map(d => ({ ...d, jenis: "Pengeluaran" }))
  ];

  semua.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

  const tbody = document.getElementById("tabelData");
  tbody.innerHTML = semua.map(d => `
    <tr class="border-b hover:bg-gray-100">
      <td class="p-3">${d.tanggal}</td>
      <td class="p-3 font-semibold ${d.jenis === 'Pemasukan' ? 'text-green-600' : 'text-red-600'}">${d.jenis}</td>
      <td class="p-3">${formatRupiah(d.jumlah)}</td>
      <td class="p-3">${d.keterangan}</td>
      <td class="p-3">${d.kategori}</td>
    </tr>
  `).join("");
}

// ======================
// FORMAT RUPIAH
// ======================
function formatRupiah(num) {
  return num.toLocaleString("id-ID", { style: "currency", currency: "IDR" });
}

// ======================
// JALANKAN
// ======================
start();
</script>
