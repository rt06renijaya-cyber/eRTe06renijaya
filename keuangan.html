<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laporan Keuangan RT 06</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --primary:#1f6feb;
    --accent:#e76f51;
    --muted:#6b7280;
    --bg:#f6f7fb;
    --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background:var(--bg);color:#0f172a;-webkit-font-smoothing:antialiased;
  }

  .wrap{max-width:1100px;margin:18px auto;padding:0 16px;}

  header.site{
    background:#16324a;color:#fff;padding:18px;border-radius:10px;
    display:flex;gap:12px;align-items:center;
  }
  .logo{width:64px;height:64px;border-radius:8px;background:center/cover no-repeat url('logo_rt06.png');flex:0 0 64px}
  .hdr-text h1{margin:0;font-size:20px;font-weight:700;line-height:1.25}
  .hdr-text p{margin:4px 0 0;font-size:12px;color:#dbeafe}

  .report-title{ text-align:center;margin:18px 0 10px;}
  .report-title h2{margin:0;color:var(--accent);font-size:22px;font-weight:700}
  .report-title p{margin:6px 0 0;color:var(--muted);font-weight:600}

  .top-grid{
    display:grid;grid-template-columns:420px 1fr;gap:18px;align-items:start;
    margin-bottom:18px;
  }
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .kpi{font-weight:700;font-size:20px;color:#0f172a}

  /* SALDO BARS */
  .saldo-wrap{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .bars{width:180px;display:flex;justify-content:center;gap:16px;align-items:end;height:150px;margin:0 auto}
  .bar{width:60px;border-radius:8px 8px 0 0;display:flex;align-items:flex-end;justify-content:center;color:#fff;font-weight:700;font-size:10px;padding-bottom:4px}
  .bar-left{background:#2b6b93}
  .bar-right{background:var(--accent)}
  .bars-label{margin-top:8px;text-align:center;color:var(--muted);font-weight:700;font-size:12px}

  .summary-stat{background:#f8fafc;border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:8px;width:100%}
  .percent{font-size:18px;font-weight:700}
  .spent{font-weight:700;font-size:22px}

  .pl-actual{display:flex;gap:12px;align-items:center;margin-top:12px}
  .pl-actual .label{width:80px;color:var(--muted);font-size:13px}
  .plbar{flex:1;height:12px;border-radius:8px;background:#eef3ff;overflow:hidden}
  .plfill{height:100%;background:linear-gradient(90deg,var(--primary),#60a5fa);width:40%}

  .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .mini-col{background:#fff;padding:10px;border-radius:8px;text-align:center;box-shadow:0 6px 16px rgba(2,6,23,0.03)}

  .section{margin-top:16px}
  .table-wrap{overflow-x:auto;border-radius:8px}
  table{width:100%;border-collapse:collapse;font-size:13px;background:var(--card)}
  th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;white-space:nowrap}
  th{background:#f8fafc;font-weight:700;color:#111827}
  tr:hover td{background:#fbfdff}

  #donutWrap canvas{
    width:100%!important;
    max-width:380px;
    display:block;
    margin:0 auto;
  }

  footer{margin:24px 0;text-align:center;color:var(--muted);font-size:13px}

  /* RESPONSIVE FIX — SMARTPHONE */

  @media (max-width:980px){
    .top-grid{grid-template-columns:1fr; }
    header.site{padding:14px}
    .hdr-text h1{font-size:18px}
  }

  @media (max-width:520px){

    .wrap{padding:0 10px;margin:12px auto}

    header.site{
      flex-direction:row;
      padding:14px;
      gap:10px;
    }
    .logo{width:50px;height:50px}
    .hdr-text h1{font-size:15px}
    .hdr-text p{font-size:11px}

    .report-title h2{font-size:18px}
    .report-title p{font-size:13px}

    /* BARS DIPERKECIL 35% */
    .bars{
      height:90px;       /* turun dari 110 */
      width:120px;       /* turun dari 140 */
      gap:10px;
    }
    .bar{
      width:32px;        /* turun dari 38 */
      font-size:8px;
    }

    .kpi{font-size:16px}
    .percent{font-size:15px}
    .spent{font-size:17px}

    .pl-actual .label{width:60px;font-size:11px}
    th,td{padding:8px;font-size:12px}
    .mini-grid{grid-template-columns:1fr}

    table th, table td{white-space:normal}
  }

  @media (max-width:380px){
    header.site{flex-direction:column;text-align:center}
    .logo{margin-bottom:8px}

    .bars{
      width:100px;
      height:70px;
      gap:8px;
    }
    .bar{
      width:28px;
      font-size:7px;
    }
  }

</style>
</head>
<body>

<div class="wrap">
<!-- HEADER -->
<header class="site">
  <div class="logo"></div>
  <div class="hdr-text">
    <h1>Laporan Keuangan RT 06</h1>
    <p>Periode berjalan</p>
  </div>
</header>

<!-- JUDUL -->
<div class="report-title">
  <h2>Ringkasan Keuangan</h2>
  <p>Saldo Awal • Pemasukan • Pengeluaran • Saldo Akhir</p>
</div>

<!-- BAGIAN SALDO -->
<div class="top-grid">

  <!-- KOTAK SALDO -->
  <div class="card">
    <h3 style="margin:0 0 12px;font-size:17px;color:#0f172a;font-weight:700;">Saldo Keuangan</h3>

    <div class="saldo-wrap">

      <div style="flex:1">
        <p style="margin:0;color:#64748b;font-size:13px;">Saldo Awal</p>
        <div class="kpi" id="saldoAwal">Rp 0</div>

        <p style="margin:12px 0 0;color:#64748b;font-size:13px;">Saldo Akhir</p>
        <div class="kpi" id="saldoAkhir">Rp 0</div>
      </div>

      <!-- BAR VERTICAL -->
      <div style="flex:1;text-align:center">
        <div class="bars">
          <div class="bar bar-left" id="barAwal" style="height:40%;">Awal</div>
          <div class="bar bar-right" id="barAkhir" style="height:60%;">Akhir</div>
        </div>
        <div class="bars-label">Perbandingan Saldo</div>
      </div>

    </div>

    <div class="summary-stat" style="margin-top:12px">
      <div class="percent" id="persentasePerubahan">0%</div>
      <div class="spent">Perubahan Saldo</div>
    </div>

  </div>

  <!-- KOTAK DONUT -->
  <div class="card">
    <h3 style="margin:0 0 12px;font-size:17px;color:#0f172a;font-weight:700;">Komposisi Pemasukan vs Pengeluaran</h3>
    <div id="donutWrap">
      <canvas id="donutChart"></canvas>
    </div>
  </div>

</div>

<!-- TABEL PEMASUKAN -->
<div class="section">
  <div class="card">
    <h3 style="font-size:17px;margin:0 0 12px;font-weight:700;">Daftar Pemasukan</h3>
    <div class="table-wrap">
      <table id="tableMasuk">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Kategori</th>
            <th>Keterangan</th>
            <th>Nominal</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- TABEL PENGELUARAN -->
<div class="section">
  <div class="card">
    <h3 style="font-size:17px;margin:0 0 12px;font-weight:700;">Daftar Pengeluaran</h3>
    <div class="table-wrap">
      <table id="tableKeluar">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Kategori</th>
            <th>Keterangan</th>
            <th>Nominal</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<footer>
  &copy; 2025 Laporan Keuangan RT 06 — Generated Automatically
</footer>
<script>
// =======================
// KONFIGURASI GOOGLE SHEET
// =======================
const SHEET_ID = "1EMYpie82paCl-vupfhyj11Z9tNGFp2p7aIDwIIl_Z0o";
const BASE_URL = `https://opensheet.elk.sh/${SHEET_ID}`;

const URL_SALDO   = `${BASE_URL}/web_SaldoAwal`;
const URL_IN      = `${BASE_URL}/web_Pemasukan`;
const URL_OUT     = `${BASE_URL}/web_Pengeluaran`;

// =======================
// FUNCTION BANTUAN
// =======================
function cleanNumber(v) {
  if (!v) return 0;
  return parseInt(String(v).replace(/[^0-9\-]/g, "")) || 0;
}
function rupiah(n) {
  return n.toLocaleString("id-ID", { style: "currency", currency: "IDR" });
}

// Ambil JSON aman
async function getJSON(url) {
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error(r.status);
    return await r.json();
  } catch (err) {
    console.error("Fetch error:", url, err);
    return [];
  }
}

// =======================
// SCRIPT UTAMA
// =======================
async function init() {
  const [saldoSheet, pemasukan, pengeluaran] = await Promise.all([
    getJSON(URL_SALDO),
    getJSON(URL_IN),
    getJSON(URL_OUT)
  ]);

  // =======================
  // 1. SALDO AWAL
  // =======================
  let saldoAwal = 0;

  if (saldoSheet.length > 0) {
    const row = saldoSheet[0];
    for (const key of Object.keys(row)) {
      if (String(key).toLowerCase().includes("saldo")) {
        saldoAwal = cleanNumber(row[key]);
        break;
      }
    }
  }

  // fallback → ambil angka pertama
  if (saldoAwal === 0) {
    for (const key of Object.keys(saldoSheet[0] || {})) {
      const val = cleanNumber(saldoSheet[0][key]);
      if (val !== 0) {
        saldoAwal = val;
        break;
      }
    }
  }

  // =======================
  // 2. HITUNG PEMASUKAN
  // =======================
  let totalIn = 0;
  pemasukan.forEach(r => {
    totalIn += cleanNumber(r.Jumlah || r.Nominal || r.Amount);
  });

  // =======================
  // 3. HITUNG PENGELUARAN
  // =======================
  let totalOut = 0;
  pengeluaran.forEach(r => {
    totalOut += cleanNumber(r.Jumlah || r.Nominal || r.Amount);
  });

  // =======================
  // 4. SALDO AKHIR
  // =======================
  const saldoAkhir = saldoAwal + totalIn - totalOut;

  // =======================
  // 5. PERUBAHAN SALDO
  // =======================
  const selisih = saldoAkhir - saldoAwal;
  const persentase = saldoAwal === 0
    ? 0
    : Math.round((selisih / Math.abs(saldoAwal)) * 100);

  // =======================
  // 6. UPDATE UI
  // =======================
  document.getElementById("saldoAwal").innerText = rupiah(saldoAwal);
  document.getElementById("saldoAkhir").innerText = rupiah(saldoAkhir);
  document.getElementById("persentasePerubahan").innerText =
    (persentase > 0 ? "+" : "") + persentase + "%";

  // =======================
  // 7. UPDATE BAR — RESPONSIVE
  // =======================
  const maxHeight = window.innerWidth < 520 ? 80 : 130; // HP lebih pendek
  const maxValue = Math.max(Math.abs(saldoAwal), Math.abs(saldoAkhir), 1);

  document.getElementById("barAwal").style.height =
    (Math.abs(saldoAwal) / maxValue) * maxHeight + "px";

  document.getElementById("barAkhir").style.height =
    (Math.abs(saldoAkhir) / maxValue) * maxHeight + "px";

  // =======================
  // 8. DONUT CHART
  // =======================
  const ctx = document.getElementById("donutChart").getContext("2d");

  new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Pemasukan", "Pengeluaran"],
      datasets: [
        {
          data: [totalIn, totalOut],
          backgroundColor: ["#1f6feb", "#e76f51"]
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });

  // =======================
  // 9. TABEL PEMASUKAN
  // =======================
  const tbIn = document.querySelector("#tableMasuk tbody");
  tbIn.innerHTML = "";

  pemasukan.forEach(r => {
    tbIn.innerHTML += `
      <tr>
        <td>${r.Tanggal || ""}</td>
        <td>${r.Kategori || ""}</td>
        <td>${r.Keterangan || ""}</td>
        <td>${rupiah(cleanNumber(r.Jumlah))}</td>
      </tr>
    `;
  });

  // =======================
  // 10. TABEL PENGELUARAN
  // =======================
  const tbOut = document.querySelector("#tableKeluar tbody");
  tbOut.innerHTML = "";

  pengeluaran.forEach(r => {
    tbOut.innerHTML += `
      <tr>
        <td>${r.Tanggal || ""}</td>
        <td>${r.Kategori || ""}</td>
        <td>${r.Keterangan || ""}</td>
        <td>${rupiah(cleanNumber(r.Jumlah))}</td>
      </tr>
    `;
  });
}

init();
</script>
<script>
// ----------------------------
// 6. UPDATE UI CARD SALDO
// ----------------------------
function updateBalanceCards() {
    document.getElementById("saldoAwal").textContent =
        formatRupiah(totalSaldoAwal);

    document.getElementById("saldoAkhir").textContent =
        formatRupiah(totalSaldoAwal + totalPemasukan - totalPengeluaran);

    document.getElementById("totalPemasukan").textContent =
        formatRupiah(totalPemasukan);

    document.getElementById("totalPengeluaran").textContent =
        formatRupiah(totalPengeluaran);
}

// ----------------------------
// 7. FORMAT RUPIAH
// ----------------------------
function formatRupiah(num) {
    return "Rp. " + num.toLocaleString("id-ID");
}

// ----------------------------
// 8. FETCH DATA SAAT PERTAMA KALI
// ----------------------------
document.addEventListener("DOMContentLoaded", loadSheetData);
</script>
</body>
</html>

