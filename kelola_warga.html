<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Data RT. 06</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #00796B; /* Hijau Tua */
            --color-secondary: #26A69A; /* Hijau Muda */
        }
        body {
            background-color: #f4f7f6;
            font-family: 'Poppins', sans-serif;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .header-title {
            color: var(--color-primary);
            font-weight: 700;
            border-bottom: 3px solid var(--color-secondary);
            display: inline-block;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        .btn-primary-custom {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
        .btn-primary-custom:hover {
            background-color: var(--color-secondary);
            border-color: var(--color-secondary);
        }
        .btn-view.active {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
        .btn-view:not(.active) {
            background-color: #f0f0f0;
            border-color: #ccc;
            color: #555;
        }
        .table thead th {
            background-color: var(--color-primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .loading {
            padding: 50px;
            font-size: 1.2em;
            color: var(--color-primary);
        }
        .no-data {
            padding: 50px;
            font-size: 1.2em;
            color: #888;
            text-align: center;
        }
        /* --- CSS Responsiveness Modal Detail --- */
        .detail-item-list {
            display: flex; /* Default: Horizontal */
            flex-direction: row;
            align-items: flex-start;
        }
        .detail-label-modal {
            flex-shrink: 0; 
            width: 150px; 
        }

        /* Media Query untuk Layar HP (max-width 767px) */
        @media (max-width: 767px) {
            .detail-item-list {
                flex-direction: column; /* Ubah ke Vertical */
                align-items: stretch;
            }
            .detail-label-modal {
                font-size: 1.05em;
                margin-bottom: 3px; 
                width: 100%; 
                border-bottom: 1px dashed #eee; 
                padding-bottom: 3px;
            }
            .list-group-item span:last-child {
                padding-top: 5px; 
                display: block; 
            }
        }
    </style>
</head>
<body>

<div class="container my-5">
    <div class="row mb-4">
        <div class="col-md-12">
            <a href="index.html" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
            </a>
            <h2 class="header-title mt-3"><i class="fas fa-users"></i> Manajemen Data RT. 06</h2>
        </div>
    </div>

    <div class="card p-4">
        <p class="text-muted">Lihat dan kelola database warga atau log pengajuan surat dari warga.</p>
        
        <div class="d-flex flex-wrap align-items-center mb-4">
            <span class="me-3">Pilih View:</span>
            
            <div class="btn-group me-3" role="group">
                <button type="button" class="btn btn-view active" id="btn-view-warga" onclick="setView('warga')">
                    <i class="fas fa-database"></i> Database Warga
                </button>
                <button type="button" class="btn btn-view" id="btn-view-pengajuan" onclick="setView('pengajuan')">
                    <i class="fas fa-file-alt"></i> Pengajuan Surat
                </button>
            </div>

            <div class="input-group flex-grow-1 me-3 my-2 my-md-0" style="max-width: 300px;">
                <input type="text" class="form-control" placeholder="Cari NIK, Nama, atau KK..." id="search-input">
                <button class="btn btn-primary-custom" type="button" onclick="searchData()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <button class="btn btn-success my-2 my-md-0" id="btn-tambah-warga" onclick="openTambahWargaModal()">
                <i class="fas fa-plus-circle"></i> Tambah Warga Baru
            </button>
        </div>

        <div id="data-table-container">
            <div class="loading text-center">Memuat data...</div>
        </div>

    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">Detail Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-content">
                <p>Detail akan ditampilkan di sini.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="tambahWargaModal" tabindex="-1" aria-labelledby="tambahWargaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tambahWargaModalLabel">Form Input Warga Baru</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Form input warga baru akan ditempatkan di sini.</p>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // GANTI DENGAN URL WEB APP ANDA YANG SUDAH DI DEPLOY
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbymhNBbvtqrJxREQiJNqxy_P-fS0IHmw3qGdLHPxk7hijEI2CEzf9DxKWZG_ijcU6eS/exec"; 

    // Variabel global untuk menyimpan data yang dimuat
    let loadedDataWarga = [];
    let loadedDataPengajuan = [];
    let currentHeaders = [];

    // Tentukan View yang aktif (default: warga)
    let currentView = 'warga';

    // =========================================================
    // KONFIGURASI 4 KOLOM UTAMA UNTUK TABEL
    // =========================================================

    const DISPLAY_INDICES = {
        // === Database Warga (Hanya 4 Kolom Penting) ===
        // Index: 0=ID Warga, 1=Nama, 2=NIK, ..., 15=Alamat Rumah
        'warga': [
            0,  // ID Warga
            1,  // Nama
            2,  // NIK
            15  // Alamat Rumah 
        ],
        // === Pengajuan Surat (Hanya 4 Kolom Penting) ===
        // Index: 0=Nama Lengkap, ..., 3=Alamat Lengkap, ..., 12=NIK, ..., 15=Keperluan Surat
        'pengajuan': [
            0,  // Nama Lengkap
            12, // No. NIK 
            15, // Keperluan Surat 
            3   // Alamat Lengkap 
        ]
    };

    // =========================================================
    // FUNGSI PENGATUR VIEW & LOADING DATA
    // =========================================================

    document.addEventListener('DOMContentLoaded', () => {
        // Panggil data saat halaman dimuat
        loadDataWarga(); 
    });

    function setView(viewType) {
        currentView = viewType;
        
        document.getElementById('btn-view-warga').classList.remove('active');
        document.getElementById('btn-view-pengajuan').classList.remove('active');

        if (viewType === 'warga') {
            document.getElementById('btn-view-warga').classList.add('active');
            document.getElementById('btn-tambah-warga').style.display = 'inline-block';
            loadDataWarga();
        } else {
            document.getElementById('btn-view-pengajuan').classList.add('active');
            document.getElementById('btn-tambah-warga').style.display = 'none';
            loadDataPengajuan();
        }
    }

    function loadDataWarga() {
        document.getElementById('data-table-container').innerHTML = '<div class="loading text-center"><i class="fas fa-spinner fa-spin"></i> Memuat Data Warga...</div>';
        
        fetch(WEB_APP_URL + '?action=getDataWarga') 
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('data-table-container').innerHTML = `<div class="alert alert-danger">**Error Memuat Data:** ${data.error}</div>`;
                    return;
                }
                
                // Simpan data mentah
                loadedDataWarga = data.data; 
                currentHeaders = data.header;

                // Bangun dan tampilkan tabel
                const htmlTable = buildTableHTML(data.header, data.data, 'warga');
                document.getElementById('data-table-container').innerHTML = htmlTable;
            })
            .catch(error => {
                console.error('Fetch error:', error);
                document.getElementById('data-table-container').innerHTML = `<div class="alert alert-danger">Error Jaringan: Gagal terhubung ke Apps Script. Cek URL Web App.</div>`;
            });
    }

    function loadDataPengajuan() {
        document.getElementById('data-table-container').innerHTML = '<div class="loading text-center"><i class="fas fa-spinner fa-spin"></i> Memuat Log Pengajuan Surat...</div>';
        
        fetch(WEB_APP_URL + '?action=getDataPengajuan') 
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('data-table-container').innerHTML = `<div class="alert alert-danger">**Error Memuat Data:** ${data.error}</div>`;
                    return;
                }
                
                // Simpan data mentah
                loadedDataPengajuan = data.data; 
                currentHeaders = data.header;

                // Bangun dan tampilkan tabel
                const htmlTable = buildTableHTML(data.header, data.data, 'pengajuan');
                document.getElementById('data-table-container').innerHTML = htmlTable;
            })
            .catch(error => {
                console.error('Fetch error:', error);
                document.getElementById('data-table-container').innerHTML = `<div class="alert alert-danger">Error Jaringan: Gagal terhubung ke Apps Script. Cek URL Web App.</div>`;
            });
    }

    // =========================================================
    // FUNGSI PEMBANGUN TABEL (DYNAMIC, HANYA 4 KOLOM)
    // =========================================================

    function buildTableHTML(header, data, type) {
        // Ambil indeks kolom yang telah dikonfigurasi (HANYA 4)
        const indices = DISPLAY_INDICES[type];

        if (data.length === 0) {
            return `<div class="no-data alert alert-light">
                        <i class="fas fa-info-circle me-2"></i> Tidak ada data ${type === 'warga' ? 'Warga' : 'Pengajuan'} yang ditemukan.
                    </div>`;
        }

        // Terapkan batas tinggi agar scrollable jika data banyak
        let tableHTML = `<div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-striped table-hover"><thead><tr>`;
        
        // Tampilkan Header HANYA untuk indeks yang dipilih
        indices.forEach(index => {
            const h = header[index];
            // Memastikan header di-capitalize dan rapi
            const cleanHeader = String(h).toUpperCase().replace(/_/g, ' ');
            tableHTML += `<th class="text-nowrap">${cleanHeader}</th>`;
        });
        tableHTML += `<th class="text-nowrap">AKSI</th></tr></thead><tbody>`;

        // Isi Baris Data HANYA untuk indeks yang dipilih
        data.forEach((row, index) => {
            tableHTML += `<tr>`;
            
            indices.forEach(i => {
                const cell = row[i];
                // Mengganti null/undefined/kosong dengan '-'
                const displayValue = cell === '' || cell === null || cell === undefined ? '-' : cell;
                tableHTML += `<td class="text-nowrap">${displayValue}</td>`;
            });

            // Tambahkan tombol Aksi (Detail)
            if (type === 'warga') {
                tableHTML += `<td class="text-nowrap"><button class="btn btn-sm btn-primary-custom" onclick="showDetailModal(${index}, 'warga')">
                                <i class="fas fa-eye"></i> Detail
                              </button></td>`;
            } else if (type === 'pengajuan') {
                tableHTML += `<td class="text-nowrap"><button class="btn btn-sm btn-info text-white" onclick="showDetailModal(${index}, 'pengajuan')">
                                <i class="fas fa-file-alt"></i> Detail
                              </button></td>`;
            }
            
            tableHTML += `</tr>`;
        });

        tableHTML += `</tbody></table></div>`;
        return tableHTML;
    }


    // =========================================================
    // FUNGSI MODAL DETAIL (RESPONSIVE)
    // =========================================================

    function showDetailModal(index, type) {
        const data = type === 'warga' ? loadedDataWarga[index] : loadedDataPengajuan[index];
        const headers = currentHeaders;

        let detailContent = '<ul class="list-group list-group-flush">';
        
        data.forEach((value, i) => {
            const header = headers[i] ? String(headers[i]).toUpperCase().replace(/_/g, ' ') : `Kolom #${i + 1}`;
            const displayValue = value === '' || value === null || value === undefined ? '-' : value;

            // Menggunakan kelas kustom detail-item-list dan detail-label-modal untuk responsiveness
            detailContent += `<li class="list-group-item detail-item-list">
                                <span class="fw-bold me-2 detail-label-modal" style="color: var(--color-primary);">${header}:</span>
                                <span>${displayValue}</span>
                              </li>`;
        });

        detailContent += '</ul>';

        document.getElementById('detailModalLabel').innerText = `Detail ${type === 'warga' ? 'Data Warga' : 'Pengajuan Surat'}`;
        document.getElementById('modal-body-content').innerHTML = detailContent;
        
        const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
        detailModal.show();
    }

    // =========================================================
    // FUNGSI LAINNYA
    // =========================================================

    function searchData() {
        alert("Fungsi pencarian belum diimplementasikan.");
    }

    function openTambahWargaModal() {
        // Tampilkan modal tambah warga baru (saat ini masih placeholder)
        const tambahWargaModal = new bootstrap.Modal(document.getElementById('tambahWargaModal'));
        tambahWargaModal.show();
    }
</script>

</body>
</html>
